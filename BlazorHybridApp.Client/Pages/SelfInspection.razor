@page "/inspect"
@rendermode InteractiveWebAssembly

<PageTitle>Self Inspection</PageTitle>

<h1>Entity Framework Model</h1>

@if (entities is null)
{
    <p>Loading...</p>
}
else
{
    <div id="ef-diagram" style="height:400px" class="mb-4"></div>
    @foreach (var entity in entities)
    {
        <h3>@entity.Name</h3>
        <ul>
            @foreach (var prop in entity.Properties)
            {
                <li>@prop.Name (@prop.Type)</li>
            }
        </ul>
    }
}

@code {
    [Inject] HttpClient Http { get; set; } = default!;
    [Inject] NavigationManager Nav { get; set; } = default!;
    [Inject] IJSRuntime JS { get; set; } = default!;

    private List<EntityInfo>? entities;

    protected override async Task OnInitializedAsync()
    {
        if (Http.BaseAddress is null)
        {
            Http = new HttpClient { BaseAddress = new Uri(Nav.BaseUri) };
        }
        entities = await Http.GetFromJsonAsync<List<EntityInfo>>("api/ef-model");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (entities is not null)
        {
            await JS.InvokeVoidAsync("efInspection.render", entities);
        }
    }
    private record EntityInfo(string Name, List<PropertyInfo> Properties, List<NavigationInfo> Navigations);
    private record PropertyInfo(string Name, string Type);
    private record NavigationInfo(string Name, string Target);
}
